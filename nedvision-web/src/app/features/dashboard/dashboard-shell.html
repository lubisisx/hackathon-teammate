<!-- Full-width fluid container for the whole page -->
<div class="container-fluid py-3 px-3 px-lg-4">
  <!-- Header -->
  <div class="container mb-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <div class="d-flex align-items-center gap-2">
        <img src="../assets/nedbank-logo.svg" width="28" height="28" alt="" />
        <div><strong>NedVision</strong> â€“ Cashflow Copilot</div>
      </div>
      <div class="badge">ðŸ‘¤ {{ orgUser }}</div>
    </div>
  </div>

  <!-- Top summary cards -->
  <div class="container mb-4">
    <div class="row g-3">
      <!-- Current Balance -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card p-3 shadow-sm h-100">
          <h3 class="h6 mb-2">Current Balance</h3>
          <div class="display-6 fw-semibold mono">
            R {{ currentBalance || 0 | number : '1.0-0' }}
          </div>
          <div class="text-success small">â†‘ R {{ deltaToday || 0 | number : '1.0-0' }} today</div>
          <div class="mt-2" *ngIf="riskNote">
            <span class="badge text-bg-danger-subtle">{{ riskNote }}</span>
          </div>
          <div class="mt-3">
            <button class="btn btn-sm btn-outline-success" (click)="connectBank()">
              Connect bank
            </button>
          </div>
        </div>
      </div>

      <!-- Upcoming Debit Orders -->
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card p-3 shadow-sm h-100">
          <h3 class="h6 mb-2">Upcoming Debit Orders</h3>
          <div class="display-6 fw-semibold mono">
            R {{ upcomingDebits || 0 | number : '1.0-0' }}
          </div>
          <div class="small text-secondary">Next 7 days</div>
          <hr class="my-2" />
          <div class="fs-4 mono">{{ invoicesDue.length }}</div>
          <div class="small text-secondary">
            Invoices Due <span class="small">Within 7 days</span>
          </div>
        </div>
      </div>

      <!-- AI Insights -->
      <div class="col-12 col-lg-4">
        <div class="card p-3 shadow-sm h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="h6 m-0">Insights</h3>
            <div class="badge text-bg-info">AI</div>
          </div>
          <div class="d-flex justify-content-between align-items-center border rounded p-2">
            <div>
              <strong>Friday dip risk</strong>
              <div class="small text-secondary">Large debit + 2 unpaid</div>
            </div>
            <button class="btn btn-sm btn-outline-primary" (click)="aiRemind()">Remind</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forecast + Right Column -->
  <div class="container">
    <div class="row g-3">
      <!-- 30-day Forecast (spans 8 columns on large screens) -->
      <div class="col-12 col-lg-8">
        <div class="card p-3 shadow-sm h-100">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="h6 m-0">30-day Forecast</h3>
            <button class="btn btn-sm btn-outline-secondary" (click)="openWhatIf()">
              View what-if
            </button>
          </div>

          <!-- Chart.js Component -->
          <app-forecast-chart
            [history]="data?.history || []"
            [forecast]="data?.forecast || []"
            [scenario]="whatIfData || []"
          >
          </app-forecast-chart>

          <div class="slideover-backdrop" [class.show]="whatIfOpen" (click)="closeWhatIf()"></div>
          <aside
            class="slideover"
            [class.show]="whatIfOpen"
            role="dialog"
            aria-label="What-if Simulation"
          >
            <div class="slideover-header">
              <h5 class="m-0">What-if Simulation</h5>
              <button class="btn btn-sm btn-outline-secondary" (click)="closeWhatIf()">
                Close
              </button>
            </div>

            <div class="slideover-body">
              <form class="vstack gap-2" (submit)="onSimulate($event)">
                <div class="row g-2">
                  <div class="col-12">
                    <label class="form-label small">Date</label>
                    <input
                      class="form-control form-control-sm"
                      type="date"
                      [(ngModel)]="whatIfDate"
                      name="whatIfDate"
                    />
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Delta (ZAR, negative for outflow)</label>
                    <input
                      class="form-control form-control-sm"
                      type="number"
                      [(ngModel)]="whatIfDelta"
                      name="whatIfDelta"
                    />
                  </div>
                  <div class="col-12">
                    <label class="form-label small">Branch</label>
                    <input
                      class="form-control form-control-sm"
                      [(ngModel)]="branch"
                      name="branch"
                    />
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button type="submit" class="btn btn-sm btn-primary">Simulate</button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    (click)="presetSalariesEarly()"
                  >
                    Preset: Salaries Early
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-warning"
                    (click)="presetInvoiceLate()"
                  >
                    Preset: Invoice Late
                  </button>
                </div>

                <hr class="my-2" />

                <div class="d-flex flex-column gap-2">
                  <label class="form-label small m-0">Upload Scenario CSV</label>
                  <input
                    #csvFile
                    type="file"
                    accept=".csv"
                    class="form-control form-control-sm"
                    (change)="onUpload(csvFile.files)"
                  />
                </div>

                <div class="d-flex flex-wrap gap-2 mt-3">
                  <button type="button" class="btn btn-sm btn-success" (click)="applyWhatIf()">
                    Apply to chart
                  </button>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    (click)="clearWhatIf()"
                  >
                    Clear
                  </button>
                </div>
              </form>
            </div>
          </aside>

          <!-- Action Buttons -->
          <div class="mt-3 d-flex flex-wrap gap-2">
            <input type="file" #file accept=".csv" (change)="onUpload(file.files)" hidden />
            <button class="btn btn-sm btn-primary" (click)="runWhatIf()">Run What-If</button>
            <button class="btn btn-sm btn-outline-primary" (click)="file.click()">
              Upload Scenario CSV
            </button>
            <button
              class="btn btn-sm btn-outline-secondary"
              *ngIf="whatIfData.length"
              (click)="clearWhatIf()"
            >
              Clear
            </button>
          </div>
        </div>
      </div>

      <!-- Right Column: Invoices + Debit Orders -->
      <div class="col-12 col-lg-4 d-flex flex-column gap-3">
        <!-- Invoices Due -->
        <div class="card p-3 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="h6 m-0">Invoices Due</h3>
            <button class="btn btn-sm btn-outline-secondary">Add invoice</button>
          </div>

          <div class="d-flex flex-column gap-2">
            <div
              class="d-flex justify-content-between align-items-center border rounded p-2"
              *ngFor="let inv of invoicesDue"
            >
              <div>
                <div>
                  <strong>{{ inv.client }}</strong>
                </div>
                <div class="badge text-bg-light">{{ inv.dueLabel }}</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <div class="mono fw-semibold">R {{ inv.amount | number : '1.0-0' }}</div>
                <button class="btn btn-sm btn-outline-success" (click)="markPaid(inv)">
                  Mark paid
                </button>
                <button class="btn btn-sm btn-outline-primary" (click)="remindInvoice(inv)">
                  Remind
                </button>
              </div>
            </div>
            <div class="small text-secondary" *ngIf="!invoicesDue.length">
              No invoices due in the next 7 days.
            </div>
          </div>
        </div>

        <!-- Debit Orders Due -->
        <div class="card p-3 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h3 class="h6 m-0">Debit Orders Due</h3>
          </div>

          <div class="d-flex flex-column gap-2">
            <div
              class="d-flex justify-content-between align-items-center border rounded p-2"
              *ngFor="let d of debitOrdersDue"
            >
              <div>
                <div>
                  <strong>{{ d.customer }}</strong>
                </div>
                <div class="badge text-bg-light">{{ d.dueLabel }}</div>
              </div>
              <div class="d-flex align-items-center gap-2">
                <div class="mono fw-semibold">R {{ d.amount | number : '1.0-0' }}</div>
                <button class="btn btn-sm btn-outline-primary">Remind</button>
              </div>
            </div>
            <div class="small text-secondary" *ngIf="!debitOrdersDue.length">
              No debit orders detected.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="container text-center text-secondary my-4 small">
    Â© 2025 NedVision â€¢ Angular 20 â€¢ .NET 9 â€¢ Azure AI
  </div>
</div>
